---
description: Core project structure and guidelines for 4lock-core (Linux-only Rust workspace: blob, container, vappc). Defines layout, what to be careful with, and engineering principles.
alwaysApply: true
---

# Core Project Rules – 4lock-core

You are working on a **Linux-only Rust workspace** that provides core crates for the 4lock platform: registry proxy (blob), rootless OCI/CRI and bootstrap (container), and vappc daemon/client (vappc). No UI; consumed by 4lock-agent via the vappc socket API.

**CRITICAL**: Always consult `.cursor/docs/` and `.cursor/rules/` before making changes. See `.cursor/rules/00-context-inclusion.mdc` for mandatory context inclusion.

## Project Layout

- **src/blob/** – Registry proxy, image pull cache, prepull, Helm.
- **src/container/** – Rootless OCI runtime, CRI server, bootstrap (intent loop, provisioner, templates, tasks), K8s components.
- **src/vappc/** – Daemon binary, client library, protocol (Unix/VSOCK). API used by 4lock-agent on Linux.
- **docker/** – `docker/dockerfiles/Dockerfile.core`, `docker/entrypoints/docker-entrypoint-core.sh`.
- **packaging/** – systemd unit, README for vappc daemon.
- **docs/** – User-facing README (build, run, packaging).
- **Makefile** – build, run, build-dev, run-dev, from-scratch, push, all. TARGET_ARCH auto-detected; optional .env.

When in doubt, prefer **small, focused modules** inside the appropriate crate.

## What You MUST Be Careful With

- **Do NOT modify**:
  - Proto definitions under `src/container/proto/` (CRI) unless you are intentionally changing the CRI contract and will update all consumers.
- **Be cautious changing**:
  - `build.rs` in any crate
  - Dockerfile and entrypoint (affects all containerized build/run)
  - Bootstrap templates and task ordering (idempotency and variable validation)

When changes are necessary in these areas, propose the plan first and wait for explicit confirmation if the impact is broad.

## Commands & Tooling (Source of Truth)

Use **existing project files** as the source of truth:

- **README.md**, **docs/README.md** – Build and run instructions.
- **Makefile** – Targets and env (TARGET_ARCH, GH_OWNER, GH_TOKEN).
- **Cargo.toml** (workspace and each crate) – Packages, features, binaries.

When you need to run commands:

- **Rust**: `cargo fmt`, `cargo clippy --all-targets --all-features` (or `-p <crate>`), `cargo test -p <crate>` or `cargo test --workspace`.
- **Build/run**: `make` (default: build then run), `make build`, `make run`, `make build-dev && make run-dev`.

Always show **exact commands** and keep them minimal and reversible.

## Cross-Cutting Engineering Principles

- **Clear separation**: blob (registry/cache), container (OCI/CRI/bootstrap), vappc (daemon/protocol/client).
- **Idempotent bootstrap**: Tasks and scripts must be safe to re-run; validate template variables.
- Preserve existing **logging** (`tracing`) and **error-handling** patterns in each crate.
- If changing **public APIs** or shared types, update all call sites and add or update tests.

## Testing & Validation

For non-trivial changes:

1. Identify which crates are impacted (blob, container, vappc).
2. Propose a minimal set of checks: `cargo check -p <crate>`, `cargo test -p <crate>`.
3. If touching container runtime/CRI, run relevant container tests.
4. For full workspace: `cargo test --workspace`.

Never assume tests pass; state what to run and what success looks like.
