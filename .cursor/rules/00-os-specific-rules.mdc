---
description: OS and environment rules for 4lock-core. Linux-only for native run; containerized build/run via Makefile + nerdctl on any host.
alwaysApply: true
---

# OS-Specific Rules – 4lock-core

4lock-core is **Linux-only** for the runtime (rootless OCI, CRI, vappc daemon). Build and run can be done **natively on Linux** or **inside a Linux container** from any host via the Makefile.

## Linux (Primary)

- **Native build/run**: Use Cargo and run the daemon binary directly. Requires Linux (rootless container stack: namespaces, uidmap, etc.). See `docs/README.md` and packaging docs for systemd.
- **Containerized build/run**: `make` (build then run), `make build`, `make run`, `make build-dev`, `make run-dev`. Uses nerdctl (or Docker) and `docker/dockerfiles/Dockerfile.core`; no need for local Rust on host if you only use `make`.
- **TARGET_ARCH**: Auto-detected from host (`uname -m` → arm64 or amd64). Override in `.env` if needed. Use native arch for container builds when possible (cross-arch can use QEMU and be slower or flaky).

## Non-Linux Hosts (macOS, Windows)

- **No native run** of the daemon or container runtime (Linux-only).
- **Build and run via container**: Run `make` (or `make build && make run`) so that the build and the daemon run inside the Linux container. Requires nerdctl (or Docker) and optional `.env` (e.g. `TARGET_ARCH`).
- Do not assume `cargo build -p vappc --bin vappc-linux-daemon` or `cargo test -p container` will succeed on non-Linux; many tests and the runtime are Linux-only.

## Makefile and .env

- **Makefile** is the source of truth for containerized workflow. Default target: build then run.
- **.env** (optional): `TARGET_ARCH`, `GH_OWNER`, `GH_TOKEN`. `GH_OWNER`/`GH_TOKEN` only required for `make push` / `make all` (push to registry).

## Summary

- **Linux**: Native Cargo build/test/run, or Makefile for containerized build/run.
- **Other hosts**: Use Makefile only (containerized); do not rely on native Cargo for running the daemon or container runtime.
- **TARGET_ARCH**: Prefer native arch for container builds; set in `.env` to override.
