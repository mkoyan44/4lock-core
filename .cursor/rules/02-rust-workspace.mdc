---
description: Rust/Cargo workspace guidelines, crate organization, error handling, and logging for 4lock-core.
alwaysApply: true
---

# Rust Workspace Rules (4lock-core)

The Rust side is a **Cargo workspace** at repo root with crates under `src/`: **blob**, **container**, **vappc** (and virtual **daemon** for building daemon-related crates).

## General Rust Guidelines

- Target **Rust 2021 or later** and follow idiomatic Rust style.
- Run `cargo fmt` on changed crates before finalizing.
- Treat `cargo clippy` warnings as guidance; avoid introducing new warnings when easy to fix.

Prefer:

- `Result<T, E>` with meaningful error types; **thiserror** (or similar) for error enums where already used.
- **tracing** for logging (`tracing::info!`, `tracing::debug!`, etc.).
- Avoid panicking in library code (`unwrap`, `expect`) unless clearly justified and consistent with local style.

## Workspace & Cross-Crate Changes

- Shared types that span crates: prefer a clear owner crate (e.g. container’s `common/`) or a small shared module in the crate that owns the concept. Avoid duplicating types across blob/container/vappc.
- When changing something that affects multiple crates:
  1. Identify all dependent crates.
  2. Update imports and call sites.
  3. Run `cargo check --workspace` and `cargo test --workspace` (or scoped `-p`).

Prefer **incremental changes** over large cross-workspace refactors in one step.

## container Crate

- **rootless/** – OCI lifecycle, bundle, orchestration, shared netns. Keep host networking and pivot_root semantics as per Linux rootless rules; do not introduce platform-specific hacks in shared paths.
- **cri/** – CRI server (RuntimeService, ImageService). Changes here affect kubelet compatibility; add tests and document behavior.
- **bootstrap/** – Intent loop, provisioner, workflows, templates. Keep tasks **idempotent**; validate template variables; use numbered script names for ordering.

## blob Crate

- Registry, cache, and server logic. Keep cache and registry APIs consistent; avoid leaking server/HTTP details into callers that only need image/metadata.

## vappc Crate

- **protocol** – Wire format used by 4lock-agent. Changes are breaking for the agent; version or extend in a backward-compatible way when possible.
- **daemon** – Single entry point for the daemon; delegates to container (provisioner, intent loop) and keeps startup/shutdown clear.

## Testing

- Unit tests next to code or in `src/<crate>/tests/`.
- Integration tests in each crate’s `tests/` as needed.
- Run `cargo test -p blob`, `cargo test -p container`, `cargo test -p vappc` (or `cargo test --workspace`) after changes.
